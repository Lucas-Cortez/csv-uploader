"use strict";var se=Object.create;var A=Object.defineProperty,ae=Object.defineProperties,ie=Object.getOwnPropertyDescriptor,ne=Object.getOwnPropertyDescriptors,pe=Object.getOwnPropertyNames,M=Object.getOwnPropertySymbols,me=Object.getPrototypeOf,V=Object.prototype.hasOwnProperty,ce=Object.prototype.propertyIsEnumerable;var L=(t,e,r)=>e in t?A(t,e,{enumerable:!0,configurable:!0,writable:!0,value:r}):t[e]=r,$=(t,e)=>{for(var r in e||(e={}))V.call(e,r)&&L(t,r,e[r]);if(M)for(var r of M(e))ce.call(e,r)&&L(t,r,e[r]);return t},J=(t,e)=>ae(t,ne(e));var ue=(t,e,r,o)=>{if(e&&typeof e=="object"||typeof e=="function")for(let s of pe(e))!V.call(t,s)&&s!==r&&A(t,s,{get:()=>e[s],enumerable:!(o=ie(e,s))||o.enumerable});return t};var d=(t,e,r)=>(r=t!=null?se(me(t)):{},ue(e||!t||!t.__esModule?A(r,"default",{value:t,enumerable:!0}):r,t));var a=(t,e,r)=>new Promise((o,s)=>{var n=m=>{try{F(r.next(m))}catch(P){s(P)}},oe=m=>{try{F(r.throw(m))}catch(P){s(P)}},F=m=>m.done?o(m.value):Promise.resolve(m.value).then(n,oe);F((r=r.apply(t,e)).next())});var y=require("zod"),xe=require("dotenv/config"),N=(o=>(o.DEVELOPMENT="development",o.PRODUCTION="production",o.TEST="test",o))(N||{}),le=y.z.object({NODE_ENV:y.z.nativeEnum(N).default("development"),PORT:y.z.coerce.number().default(3e3),DATABASE_URL:y.z.string()}),v=le.parse(process.env);var j=d(require("express")),te=d(require("cors")),Rr=require("express-async-errors");var ee=require("express");var X=require("express"),O=d(require("multer"));var g=class{constructor(e){this.uploadFileUseCase=e}uploadFile(e,r){return a(this,null,function*(){let o=yield this.uploadFileUseCase.execute({file:e.file});return r.status(200).json(o)})}};var i=class extends Error{constructor({statusCode:e,message:r}){super(r),this.statusCode=e}};var U=class{constructor(e){this.parser=e}convert(e,r){return new Promise((o,s)=>{try{this.parser.parse(e,{header:!0,complete:n=>{r&&r(n.data),o(n.data)},error:n=>s(n)})}catch(n){throw new i({statusCode:500,message:"An error occurred while parsing the CSV file, the file must contain valid data(name, city, country, favorite_sport)."})}})}};var Z=require("crypto");var f=class t{constructor(e){this.userId=e.userId,this.name=e.name,this.city=e.city,this.country=e.country,this.favoriteSport=e.favoriteSport}static create(e){return new t(J($({},e),{userId:(0,Z.randomUUID)()}))}static restore(e){return new t(e)}};var h=class{static create(e){return f.create({name:e.name,city:e.city,country:e.country,favoriteSport:e.favorite_sport})}};var c=require("zod");function x(t){return e=>{let r=t.safeParse(e);if(!r.success)throw new i({message:r.error.message,statusCode:500});return r.data}}var C;(r=>(r.schema=c.z.array(c.z.object({name:c.z.string(),city:c.z.string(),country:c.z.string(),favorite_sport:c.z.string()})),r.validate=x(r.schema)))(C||(C={}));var R=class{constructor(e,r){this.userRepository=e;this.csvToJsonConverterService=r}execute(e){return a(this,null,function*(){if(!e.file)throw new i({statusCode:400,message:"File not found"});let r=e.file.buffer.toString("utf-8"),s=(yield this.csvToJsonConverterService.convert(r,C.validate)).map(n=>h.create(n));return yield this.userRepository.createMany(s),{message:"The file was uploaded successfully."}})}};var B=require("drizzle-orm/better-sqlite3"),H=d(require("better-sqlite3"));var fe=new H.default(v.DATABASE_URL),Q=(0,B.drizzle)(fe,{logger:v.NODE_ENV==="development"});var l=require("drizzle-orm");var K=require("crypto"),p=require("drizzle-orm/sqlite-core"),u=(0,p.sqliteTable)("users",{userId:(0,p.text)("userId").primaryKey().$defaultFn(()=>(0,K.randomUUID)()),name:(0,p.text)("name").notNull(),city:(0,p.text)("city").notNull(),country:(0,p.text)("country").notNull(),favoriteSport:(0,p.text)("favoriteSport").notNull()});var S=class{constructor(e){this.db=e}createMany(e){return a(this,null,function*(){yield this.db.insert(u).values(e)})}findAll(e){return a(this,null,function*(){let r=this.db.select().from(u).$dynamic();return e!=null&&e.term&&r.where((0,l.or)((0,l.like)(u.name,`%${e.term}%`),(0,l.like)(u.city,`%${e.term}%`),(0,l.like)(u.country,`%${e.term}%`),(0,l.like)(u.favoriteSport,`%${e.term}%`))),(yield r).map(s=>f.restore(s))})}};var q=require("zod");var E;(r=>(r.schema=q.z.object({term:q.z.string().optional()}),r.validate=x(r.schema)))(E||(E={}));var I=class{constructor(e){this.searchUserUseCase=e}search(e,r){return a(this,null,function*(){let o=E.validate({term:e.query.q}),s=yield this.searchUserUseCase.execute(o);return r.status(200).json(s)})}};var T=class{constructor(e){this.userRepository=e}execute(e){return a(this,null,function*(){return{data:yield this.userRepository.findAll({term:e.term})}})}};var D=new S(Q),de=new T(D),k=new I(de);var G=d(require("papaparse")),ye=new U(G.default),ve=new R(D,ye),W=new g(ve);var z=(0,X.Router)(),ge=(0,O.default)({storage:O.default.memoryStorage(),limits:{files:1},fileFilter(t,e,r){if(e.mimetype!=="text/csv")return r(new i({message:"Please upload a csv file",statusCode:500}));r(null,!0)}});z.post("/",ge.single("file"),(t,e)=>a(void 0,null,function*(){return W.uploadFile(t,e)}));var Y=require("express");var _=(0,Y.Router)();_.get("/",(t,e)=>k.search(t,e));var w=(0,ee.Router)();w.use("/files",z);w.use("/users",_);var re=(t,e,r,o)=>(console.log(t),t instanceof i?r.status(t.statusCode).json({statusCode:t.statusCode,message:t.message}):r.status(500).json({statusCode:500,message:"internal server error"}));var b=class{constructor(){this.app=(0,j.default)(),this.config()}config(){this.configureParsers(),this.configureCORS(),this.configureRoutes(),this.configureErrorHandling()}configureParsers(){this.app.use(j.default.json())}configureRoutes(){this.app.use("/api",w)}configureCORS(){this.app.use((0,te.default)())}configureErrorHandling(){this.app.use(re)}listen(e){this.app.listen(e)}};var Ue=new b;Ue.listen(v.PORT);
