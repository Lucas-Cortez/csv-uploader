var H=Object.defineProperty,Q=Object.defineProperties;var K=Object.getOwnPropertyDescriptors;var D=Object.getOwnPropertySymbols;var k=Object.prototype.hasOwnProperty,G=Object.prototype.propertyIsEnumerable;var O=(t,e,r)=>e in t?H(t,e,{enumerable:!0,configurable:!0,writable:!0,value:r}):t[e]=r,z=(t,e)=>{for(var r in e||(e={}))k.call(e,r)&&O(t,r,e[r]);if(D)for(var r of D(e))G.call(e,r)&&O(t,r,e[r]);return t},_=(t,e)=>Q(t,K(e));var s=(t,e,r)=>new Promise((o,i)=>{var n=p=>{try{b(r.next(p))}catch(F){i(F)}},B=p=>{try{b(r.throw(p))}catch(F){i(F)}},b=p=>p.done?o(p.value):Promise.resolve(p.value).then(n,B);b((r=r.apply(t,e)).next())});import{z as d}from"zod";import"dotenv/config";var P=(o=>(o.DEVELOPMENT="development",o.PRODUCTION="production",o.TEST="test",o))(P||{}),W=d.object({NODE_ENV:d.nativeEnum(P).default("development"),PORT:d.coerce.number().default(3e3),DATABASE_URL:d.string()}),l=W.parse(process.env);import Z from"express";import fe from"cors";import"express-async-errors";import{Router as le}from"express";import{Router as me}from"express";import $ from"multer";var y=class{constructor(e){this.uploadFileUseCase=e}uploadFile(e,r){return s(this,null,function*(){let o=yield this.uploadFileUseCase.execute({file:e.file});return r.status(200).json(o)})}};var a=class extends Error{constructor({statusCode:e,message:r}){super(r),this.statusCode=e}};var v=class{constructor(e){this.parser=e}convert(e,r){return new Promise((o,i)=>{try{this.parser.parse(e,{header:!0,complete:n=>{r&&r(n.data),o(n.data)},error:n=>i(n)})}catch(n){throw new a({statusCode:500,message:"An error occurred while parsing the CSV file, the file must contain valid data(name, city, country, favorite_sport)."})}})}};import{randomUUID as X}from"crypto";var c=class t{constructor(e){this.userId=e.userId,this.name=e.name,this.city=e.city,this.country=e.country,this.favoriteSport=e.favoriteSport}static create(e){return new t(_(z({},e),{userId:X()}))}static restore(e){return new t(e)}};var g=class{static create(e){return c.create({name:e.name,city:e.city,country:e.country,favoriteSport:e.favorite_sport})}};import{z as u}from"zod";function U(t){return e=>{let r=t.safeParse(e);if(!r.success)throw new a({message:r.error.message,statusCode:500});return r.data}}var h;(r=>(r.schema=u.array(u.object({name:u.string(),city:u.string(),country:u.string(),favorite_sport:u.string()})),r.validate=U(r.schema)))(h||(h={}));var x=class{constructor(e,r){this.userRepository=e;this.csvToJsonConverterService=r}execute(e){return s(this,null,function*(){if(!e.file)throw new a({statusCode:400,message:"File not found"});let r=e.file.buffer.toString("utf-8"),i=(yield this.csvToJsonConverterService.convert(r,h.validate)).map(n=>g.create(n));return yield this.userRepository.createMany(i),{message:"The file was uploaded successfully."}})}};import{drizzle as Y}from"drizzle-orm/better-sqlite3";import ee from"better-sqlite3";var re=new ee(l.DATABASE_URL),j=Y(re,{logger:l.NODE_ENV==="development"});import{like as C,or as se}from"drizzle-orm";import{randomUUID as te}from"crypto";import{sqliteTable as oe,text as f}from"drizzle-orm/sqlite-core";var m=oe("users",{userId:f("userId").primaryKey().$defaultFn(()=>te()),name:f("name").notNull(),city:f("city").notNull(),country:f("country").notNull(),favoriteSport:f("favoriteSport").notNull()});var R=class{constructor(e){this.db=e}createMany(e){return s(this,null,function*(){yield this.db.insert(m).values(e)})}findAll(e){return s(this,null,function*(){let r=this.db.select().from(m).$dynamic();return e!=null&&e.term&&r.where(se(C(m.name,`%${e.term}%`),C(m.city,`%${e.term}%`),C(m.country,`%${e.term}%`),C(m.favoriteSport,`%${e.term}%`))),(yield r).map(i=>c.restore(i))})}};import{z as M}from"zod";var S;(r=>(r.schema=M.object({term:M.string().optional()}),r.validate=U(r.schema)))(S||(S={}));var E=class{constructor(e){this.searchUserUseCase=e}search(e,r){return s(this,null,function*(){let o=S.validate({term:e.query.q}),i=yield this.searchUserUseCase.execute(o);return r.status(200).json(i)})}};var I=class{constructor(e){this.userRepository=e}execute(e){return s(this,null,function*(){return{data:yield this.userRepository.findAll({term:e.term})}})}};var A=new R(j),ae=new I(A),L=new E(ae);import ie from"papaparse";var ne=new v(ie),pe=new x(A,ne),V=new y(pe);var N=me(),ce=$({storage:$.memoryStorage(),limits:{files:1},fileFilter(t,e,r){if(e.mimetype!=="text/csv")return r(new a({message:"Please upload a csv file",statusCode:500}));r(null,!0)}});N.post("/",ce.single("file"),(t,e)=>s(void 0,null,function*(){return V.uploadFile(t,e)}));import{Router as ue}from"express";var q=ue();q.get("/",(t,e)=>L.search(t,e));var T=le();T.use("/files",N);T.use("/users",q);var J=(t,e,r,o)=>(console.log(t),t instanceof a?r.status(t.statusCode).json({statusCode:t.statusCode,message:t.message}):r.status(500).json({statusCode:500,message:"internal server error"}));var w=class{constructor(){this.app=Z(),this.config()}config(){this.configureParsers(),this.configureCORS(),this.configureRoutes(),this.configureErrorHandling()}configureParsers(){this.app.use(Z.json())}configureRoutes(){this.app.use("/api",T)}configureCORS(){this.app.use(fe())}configureErrorHandling(){this.app.use(J)}listen(e){this.app.listen(e)}};var de=new w;de.listen(l.PORT);
